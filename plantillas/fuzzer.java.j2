{# ============================================================================= #}
{#                                   MACROS                                     #}
{# ============================================================================= #}

{# Macro para construir parámetros de forma recursiva #}
{% macro build_parameter(param, parent_name="", indent_level=2) %}
    {% set indent = " " * (indent_level * 4) %}
    {% set constructor_list = param.constructor or param.parameterConstructors %}
    
    {% if constructor_list %}
        {# Si el parámetro tiene constructor, crear parámetros anidados #}
        {% set constructor = constructor_list[0] %}
        
        {# Recursivamente construir parámetros del constructor #}
        {% for nested_param in constructor.parameters %}
{{ build_parameter(nested_param, parent_name=parent_name + param.name + "_", indent_level=indent_level) }}
        {% endfor %}
        
        {# Crear la instancia del objeto complejo #}
{{ indent }}{{ param.type }} {{ parent_name }}{{ param.name }} = new {{ param.type }}(
        {% for nested_param in constructor.parameters %}
{{ " " * ((indent_level + 1) * 4) }}{{ parent_name }}{{ param.name }}_{{ nested_param.name }}{% if not loop.last %},{% endif %}
        {% endfor %}
{{ indent }});
    {% else %}
        {# Parámetro simple, usar dataProvider directamente #}
{{ indent }}{{ param.type }} {{ parent_name }}{{ param.name }} = {{ param.fuzz_method }};
    {% endif %}
{% endmacro %}

{# Macro para encontrar y recopilar imports necesarios #}
{% macro find_imports(params) %}
    {% for param in params %}
        {% set constructor_list = param.constructor or param.parameterConstructors %}
        {% if constructor_list %}
            {% if param.type not in imports %}
                {% set _ = imports.append(param.type) %}
            {% endif %}
{{ find_imports(constructor_list[0].parameters) }}
        {% endif %}
    {% endfor %}
{% endmacro %}

{# ============================================================================= #}
{#                            ESTRUCTURA DEL ARCHIVO                            #}
{# ============================================================================= #}

{# Package declaration #}
{{ packageName }}

{# Imports básicos #}
import com.code_intelligence.jazzer.api.FuzzedDataProvider;
import {{ qualifierType }};

{# Recopilar imports adicionales #}
{% set imports = [] %}
{{ find_imports(parameters) }}
{# También buscar imports en constructorParameters #}
{% if constructorParameters %}
{{ find_imports(constructorParameters[0].parameters) }}
{% endif %}

{# Imports dinámicos basados en parámetros #}
{% for import_path in imports|unique %}
import {{ import_path }};
{% endfor %}

{# Import estándar para excepciones #}
import java.io.IOException;

{# ============================================================================= #}
{#                               CLASE FUZZER                                   #}
{# ============================================================================= #}

/**
 * Fuzzer generado para la clase {{ className }}.
 * Objetivo: {% if artifactName %}método {{ artifactName }}{% else %}constructor{% endif %} en la línea {{ lineNumber }}.
 */
public class {{ className | default(qualifierType_simple_name) }}{{ artifactName | default("Constructor") | capitalize }}Fuzzer {

    public static void fuzzerTestOneInput(FuzzedDataProvider dataProvider) {
        
        // === GENERACIÓN DE PARÁMETROS PARA MÉTODOS ===
        {% for param in parameters %}
{{ build_parameter(param, indent_level=2).strip() }}
        {% endfor %}

        // === CREACIÓN DE LA INSTANCIA ===
        {% if not isStatic and nodeType != 'CtConstructorImpl' %}
            {% if constructorParameters and constructorParameters|length > 0 %}
                {# Generar parámetros para el constructor de la instancia #}
                {% for param in constructorParameters[0].parameters %}
{{ build_parameter(param, parent_name="constructor_", indent_level=2).strip() }}
                {% endfor %}
        
        {{ qualifierType_simple_name }} {{ instance_name }} = new {{ qualifierType_simple_name }}(
                {% for param in constructorParameters[0].parameters %}
            constructor_{{ param.name }}{% if not loop.last %},{% endif %}
                {% endfor %}
        );
            {% else %}
        {{ qualifierType_simple_name }} {{ instance_name }} = new {{ qualifierType_simple_name }}();
            {% endif %}
        {% endif %}

        // === LLAMADA AL MÉTODO O CONSTRUCTOR OBJETIVO ===
        try {
            {% if nodeType == 'CtConstructorImpl' %}
            new {{ qualifierType_simple_name }}({{ parameters | map(attribute='name') | join(', ') }});
            {% else %}
                {% if isStatic %}
            {{ qualifierType_simple_name }}.{{ artifactName }}({{ parameters | map(attribute='name') | join(', ') }});
                {% else %}
            {{ instance_name }}.{{ artifactName }}({{ parameters | map(attribute='name') | join(', ') }});
                {% endif %}
            {% endif %}
        } catch (Exception e) {
            // Ignorar excepciones esperadas
        }
    }
}